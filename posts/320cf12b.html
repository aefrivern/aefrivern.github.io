<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>全栈公开课 | old-driver-zeroの小屋</title><meta name="author" content="old_driver_zero"><meta name="copyright" content="old_driver_zero"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Web app 基础 web 开发第一原则：始终打开控制台 可以在控制台查看网络信息 传统 web 应用：获取 html，获取 css，获取 JavaScript html 是树状的结构（DOM） 可以从控制台操作 DOM 接下来是 AJAX Asynchronous JavaScript and XML 时代 React 入门 React 简介 先安装 Node.js 创建">
<meta property="og:type" content="article">
<meta property="og:title" content="全栈公开课">
<meta property="og:url" content="https://old-driver-zero.github.io/posts/320cf12b.html">
<meta property="og:site_name" content="old-driver-zeroの小屋">
<meta property="og:description" content="Web app 基础 web 开发第一原则：始终打开控制台 可以在控制台查看网络信息 传统 web 应用：获取 html，获取 css，获取 JavaScript html 是树状的结构（DOM） 可以从控制台操作 DOM 接下来是 AJAX Asynchronous JavaScript and XML 时代 React 入门 React 简介 先安装 Node.js 创建">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://old-driver-zero.github.io/gallery/cover/%E5%85%A8%E6%A0%88%E5%85%AC%E5%BC%80%E8%AF%BE.webp">
<meta property="article:published_time" content="2023-12-27T00:17:22.000Z">
<meta property="article:modified_time" content="2024-03-07T00:17:22.000Z">
<meta property="article:author" content="old_driver_zero">
<meta property="article:tag" content="赫尔辛基大学">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://old-driver-zero.github.io/gallery/cover/%E5%85%A8%E6%A0%88%E5%85%AC%E5%BC%80%E8%AF%BE.webp"><link rel="shortcut icon" href="/illustration/favicon.ico"><link rel="canonical" href="https://old-driver-zero.github.io/posts/320cf12b.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?da75f0595ffd5e578744142f5a6a471e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"GY5EJYJ1FS","apiKey":"c443c952672ec7062840aac45536181e","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '全栈公开课',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-07 08:17:22'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/c/font_4031045_izvon5l4fr8.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/article title.css"><link rel="stylesheet" href="/css/card author.css"><link rel="stylesheet" href="/css/transpancy.css"><script src="/js/echarts.min.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@1.0.17/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="/atom.xml" title="old-driver-zeroの小屋" type="application/atom+xml">
</head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/illustration/%E5%A4%B4%E5%83%8F_%E7%81%B0%E5%A4%AA%E7%8B%BC.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">103</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">161</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-shouye-01"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shouye-01"/></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guidang"/></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-a-16-01-01"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-a-16-01-01"/></svg><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-wenjianjia"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wenjianjia"/></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/anime/"><i class="fa-fw icon-zhifeiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"/></svg><span> 二次元</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/gallery/"><i class="fa-fw icon-xiangce"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiangce"/></svg><span> 画廊</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-guanyu"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyu"/></svg><span> 关于</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/charts/"><i class="fa-fw icon-tongjichaxun"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongjichaxun"/></svg><span> 统计</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-liuyan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyan"/></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/random/"><i class="fa-fw icon-suiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-suiji"/></svg><span> 随便逛逛</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/gallery/cover/%E5%85%A8%E6%A0%88%E5%85%AC%E5%BC%80%E8%AF%BE.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="old-driver-zeroの小屋"><span class="site-name">old-driver-zeroの小屋</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><svg class="meta_icon post-ui-icon" style="width:16px;height:16px;position:relative;top:3px"><use xlink:href="#icon-sousuo1"/></svg><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-shouye-01"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shouye-01"/></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-guidang"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guidang"/></svg><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="fa-fw icon-a-16-01-01"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-a-16-01-01"/></svg><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-wenjianjia"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-wenjianjia"/></svg><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/anime/"><i class="fa-fw icon-zhifeiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"/></svg><span> 二次元</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/gallery/"><i class="fa-fw icon-xiangce"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiangce"/></svg><span> 画廊</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-guanyu"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guanyu"/></svg><span> 关于</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/charts/"><i class="fa-fw icon-tongjichaxun"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-tongjichaxun"/></svg><span> 统计</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-liuyan"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-liuyan"/></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/random/"><i class="fa-fw icon-suiji"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-suiji"/></svg><span> 随便逛逛</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">全栈公开课</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-ui-icon" style="width:16px;height:16px;position:relative;top:3px"><use xlink:href="#icon-rili"/></svg><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-27T00:17:22.000Z" title="发表于 2023-12-27 08:17:22">2023-12-27</time><span class="post-meta-separator">|</span><svg class="meta_icon post-ui-icon" style="width:13px;height:13px;position:relative;top:2px"><use xlink:href="#icon-gengxin"/></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-07T00:17:22.000Z" title="更新于 2024-03-07 08:17:22">2024-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><a class="faa-parent animated-hover"></a><svg class="meta_icon post-ui-icon" style="width:13px;height:13px;position:relative;top:2px"><use xlink:href="#icon-fenlei"/></svg><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-ui-icon" style="width:16px;height:16px;position:relative;top:3px"><use xlink:href="#icon-word"/></svg><span class="post-meta-label">字数总计:</span><span class="word-count">8022</span><span class="post-meta-separator">|</span><svg class="meta_icon post-ui-icon" style="width:16px;height:16px;position:relative;top:3px"><use xlink:href="#icon-shizhong"/></svg><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h1 id="web-app-基础">Web app 基础</h1>
<p>web 开发第一原则：<strong>始终打开控制台</strong></p>
<p>可以在控制台查看网络信息</p>
<p>传统 web 应用：获取 html，获取 css，获取 JavaScript</p>
<p>html 是树状的结构（<strong>DOM</strong>）</p>
<p>可以从控制台操作 DOM</p>
<p>接下来是 <strong>AJAX Asynchronous JavaScript and XML</strong>
时代</p>
<h1 id="react-入门">React 入门</h1>
<h2 id="react-简介">React 简介</h2>
<p>先安装 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://nodejs.org/en">Node.js</a></p>
<p>创建应用：<code>npx create-react-app part1</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello world<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure>
<p>.jsx 文件看起来返回的是 HTML 标记，实际上底层转化为了 JavaScript</p>
<p>注意 JSX 的每个标签都必须关闭，即写成 <code>&lt;br /&gt;</code></p>
<p>使用 <code>props</code> 向组件传递数据</p>
<p>React 组件名称必须大写</p>
<p>React 组件内容需要包含一个根元素，故返回值的最外层通常要加上
<code>&lt;div&gt;&lt;/div&gt;</code> 或
<code>&lt;&gt;&lt;/&gt;</code></p>
<h2 id="组件状态事件处理">组件状态，事件处理</h2>
<p>可以在组件内部定义助手函数</p>
<p>结构可用于参数传递时，如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Hello</span> = (<span class="hljs-params">&#123; name, age &#125;</span>) =&gt; &#123;&#125;;<br></code></pre></td></tr></table></figure>
<p>状态钩子的用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [counter, setCounter] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCounter</span>(counter + <span class="hljs-number">1</span>), <span class="hljs-number">1000</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;counter&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;<br></code></pre></td></tr></table></figure>
<p>事件处理：注意要求的事件处理器是对函数的引用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [counter, setCounter] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;clicked&quot;</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;counter&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span>plus<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="深入-react-应用调试">深入 React 应用调试</h2>
<p>复杂状态：可以使用对象或数组作为状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [clicks, setClicks] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">0</span> &#125;);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLeftClick</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">setClicks</span>(&#123; ...clicks, <span class="hljs-attr">left</span>: clicks.<span class="hljs-property">left</span> + <span class="hljs-number">1</span> &#125;);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRightClick</span> = (<span class="hljs-params"></span>) =&gt;<br>    <span class="hljs-title function_">setClicks</span>(&#123; ...clicks, <span class="hljs-attr">right</span>: clicks.<span class="hljs-property">right</span> + <span class="hljs-number">1</span> &#125;);<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;clicks.left&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleLeftClick&#125;</span>&gt;</span>left<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleRightClick&#125;</span>&gt;</span>right<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;clicks.right&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><code>useState</code> 函数<strong>只能</strong>直接在 component
中定义</p>
<h1 id="与服务端通信">与服务端通信</h1>
<h2 id="从渲染集合到模块学习">从渲染集合到模块学习</h2>
<p>可以使用 <code>map</code> 函数从数组中生成渲染对象，注意要有 key
属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">notes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;note.id&#125;</span>&gt;</span>&#123;note.content&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>);<br></code></pre></td></tr></table></figure>
<h2 id="表单">表单</h2>
<p>输入框处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params">props</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [newNote, setNewNote] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;a new note...&quot;</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNoteChange</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>    <span class="hljs-title function_">setNewNote</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;addNote&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;newNote&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleNoteChange&#125;</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>save<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="从服务器获取数据">从服务器获取数据</h2>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/typicode/json-server">json-server</a>，安装为开发依赖项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs npm">npm install json-server --save-dev<br></code></pre></td></tr></table></figure>
<p>在 <code>package.json</code> 文件的 <code>scripts</code>
部分做一个小小的补充：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-string">&quot;server&quot;</span>: <span class="hljs-string">&quot;json-server -p3001 --watch db.json&quot;</span><br></code></pre></td></tr></table></figure>
<p>数据存储在 <code>db.json</code> 中</p>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/axios/axios">axios</a>
库来代替浏览器和服务器之间的通信</p>
<p>effect hook 可以对函数组件进行副作用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;effect&quot;</span>);<br>  axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;http://localhost:3001/notes&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;promise fulfilled&quot;</span>);<br>    <span class="hljs-title function_">setNotes</span>(response.<span class="hljs-property">data</span>);<br>  &#125;);<br>&#125;, []);<br></code></pre></td></tr></table></figure>
<p><code>useEffect</code> 第二个参数用于指定效果的运行频率，这里使用
<code>[]</code> 表示只在第一次渲染时运行</p>
<h2 id="在服务端将数据-alert-出来">在服务端将数据 Alert 出来</h2>
<p>json-server 比较接近 RESTful 的 API</p>
<p>在 REST 中，把单个数据对象称作资源，可以通过 <code>note/3</code>
找到一个单独的笔记，其中 <code>3</code> 表示该笔记的 id</p>
<p>json-server 的所有数据用 json 格式发送</p>
<p>向服务器发送数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript">addNote = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">preventDefault</span>();<br>  <span class="hljs-keyword">const</span> noteObject = &#123;<br>    <span class="hljs-attr">content</span>: newNote,<br>    <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),<br>    <span class="hljs-attr">important</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>,<br>  &#125;;<br><br>  axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;http://localhost:3001/notes&quot;</span>, noteObject).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">setNotes</span>(notes.<span class="hljs-title function_">concat</span>(response.<span class="hljs-property">data</span>));<br>    <span class="hljs-title function_">setNewNote</span>(<span class="hljs-string">&quot;&quot;</span>);<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>使用 HTTP PUT 请求来替换整个笔记：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleImportanceOf</span> = (<span class="hljs-params">id</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> url = <span class="hljs-string">`http://localhost:3001/notes/<span class="hljs-subst">$&#123;id&#125;</span>`</span>;<br>  <span class="hljs-keyword">const</span> note = notes.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n.<span class="hljs-property">id</span> === id);<br>  <span class="hljs-keyword">const</span> changedNote = &#123; ...note, <span class="hljs-attr">important</span>: !note.<span class="hljs-property">important</span> &#125;;<br><br>  axios.<span class="hljs-title function_">put</span>(url, changedNote).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">setNotes</span>(notes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> (note.<span class="hljs-property">id</span> !== id ? note : response.<span class="hljs-property">data</span>)));<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>将其分离成一个单独的模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span>;<br><span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">&quot;http://localhost:3001/notes&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getAll</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> request = axios.<span class="hljs-title function_">get</span>(baseUrl);<br>  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">create</span> = (<span class="hljs-params">newObject</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> request = axios.<span class="hljs-title function_">post</span>(baseUrl, newObject);<br>  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">id, newObject</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> request = axios.<span class="hljs-title function_">put</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;baseUrl&#125;</span>/<span class="hljs-subst">$&#123;id&#125;</span>`</span>, newObject);<br>  <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>);<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123; getAll, create, update &#125;;<br></code></pre></td></tr></table></figure>
<p>直接调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    noteService.<span class="hljs-title function_">getAll</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">initialNotes</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setNotes</span>(initialNotes);<br>    &#125;);<br>  &#125;, []);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleImportanceOf</span> = (<span class="hljs-params">id</span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> note = notes.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n.<span class="hljs-property">id</span> === id);<br>    <span class="hljs-keyword">const</span> changedNote = &#123; ...note, <span class="hljs-attr">important</span>: !note.<span class="hljs-property">important</span> &#125;;<br>    noteService.<span class="hljs-title function_">update</span>(id, changedNote).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">returnedNote</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setNotes</span>(notes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> (note.<span class="hljs-property">id</span> !== id ? note : returnedNote)));<br>    &#125;);<br>  &#125;;<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addNote</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>    event.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-keyword">const</span> noteObject = &#123;<br>      <span class="hljs-attr">content</span>: newNote,<br>      <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),<br>      <span class="hljs-attr">important</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>,<br>    &#125;;<br>    noteService.<span class="hljs-title function_">create</span>(noteObject).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">returnedNote</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setNotes</span>(notes.<span class="hljs-title function_">concat</span>(returnedNote));<br>      <span class="hljs-title function_">setNewNote</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    &#125;);<br>  &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="给-react-应用加点样式">给 React 应用加点样式</h2>
<p>除了定义另外一个 css 文件并引入的方法外，还支持内联样式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Footer</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> footerStyle = &#123;<br>    <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;green&quot;</span>,<br>    <span class="hljs-attr">fontStyle</span>: <span class="hljs-string">&quot;italic&quot;</span>,<br>    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;footerStyle&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span></span><br><span class="language-xml">        Note app, Department of Computer Science, University of Helsinki 2022</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br></code></pre></td></tr></table></figure>
<h1 id="用-nodejs-和-express-写服务端程序">用 NodeJS 和 Express
写服务端程序</h1>
<h2 id="node.js-与-express">Node.js 与 Express</h2>
<p>可以在 package.json 文件中写脚本，并 <code>npm run 脚本名</code>
运行</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node index.js&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>
<p>这里使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/expressjs/express">express</a>
库的接口：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>)<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()<br><span class="hljs-keyword">let</span> notes = [...]<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123; response.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;&lt;h1&gt;Hello World!&lt;/h1&gt;&#x27;</span>) &#125;)<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/notes&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123; response.<span class="hljs-title function_">json</span>(notes) &#125;)<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3001</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server running on port <span class="hljs-subst">$&#123;PORT&#125;</span>`</span>) &#125;)<br></code></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/remy/nodemon">nodemon</a>
可以在代码修改后自动重启服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install --save-dev nodemon<br></code></pre></td></tr></table></figure>
<p>REST API：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">URL</th>
<th style="text-align: left;">动作</th>
<th style="text-align: left;">功能</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">notes/10</td>
<td style="text-align: left;">GET</td>
<td style="text-align: left;">获取一个资源</td>
</tr>
<tr class="even">
<td style="text-align: left;">notes</td>
<td style="text-align: left;">GET</td>
<td style="text-align: left;">获取集合中所有的资源</td>
</tr>
<tr class="odd">
<td style="text-align: left;">notes</td>
<td style="text-align: left;">POST</td>
<td style="text-align: left;">基于 request data 创建新的资源</td>
</tr>
<tr class="even">
<td style="text-align: left;">notes/10</td>
<td style="text-align: left;">DELETE</td>
<td style="text-align: left;">移除该资源</td>
</tr>
<tr class="odd">
<td style="text-align: left;">notes/10</td>
<td style="text-align: left;">PUT</td>
<td style="text-align: left;">用 request data 替代该资源</td>
</tr>
<tr class="even">
<td style="text-align: left;">notes/10</td>
<td style="text-align: left;">PATCH</td>
<td style="text-align: left;">用 request data 替代该资源的一部分</td>
</tr>
</tbody>
</table>
<p>获取单独的资源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/notes/:id&quot;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> id = <span class="hljs-title class_">Number</span>(request.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);<br>  <span class="hljs-keyword">const</span> note = notes.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> note.<span class="hljs-property">id</span> === id);<br>  response.<span class="hljs-title function_">json</span>(note);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>删除资源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">delete</span>(<span class="hljs-string">&quot;/api/notes/:id&quot;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> id = <span class="hljs-title class_">Number</span>(request.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);<br>  notes = notes.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> note.<span class="hljs-property">id</span> !== id);<br>  response.<span class="hljs-title function_">status</span>(<span class="hljs-number">204</span>).<span class="hljs-title function_">end</span>();<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>vscode 可以装 REST client 插件测试</p>
<p>接收数据要加入 json 解释器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>()); <span class="hljs-comment">// 加入 json 解释器</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">generateId</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> maxId = notes.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...notes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">n</span>) =&gt;</span> n.<span class="hljs-property">id</span>)) : <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> maxId + <span class="hljs-number">1</span>;<br>&#125;;<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/api/notes&quot;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> body = request.<span class="hljs-property">body</span>;<br>  <span class="hljs-keyword">if</span> (!body.<span class="hljs-property">content</span>)<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;content missing&quot;</span> &#125;);<br><br>  <span class="hljs-keyword">const</span> note = &#123;<br>    <span class="hljs-attr">content</span>: body.<span class="hljs-property">content</span>,<br>    <span class="hljs-attr">important</span>: body.<span class="hljs-property">important</span> || <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),<br>    <span class="hljs-attr">id</span>: <span class="hljs-title function_">generateId</span>(),<br>  &#125;;<br><br>  notes = notes.<span class="hljs-title function_">concat</span>(note);<br>  response.<span class="hljs-title function_">json</span>(note);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>注意 REST 测试时要指明数据类型：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">http://localhost:3001/api/notes/</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">content-type</span><span class="hljs-punctuation">: </span>application/json<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span></span><br><span class="language-json">    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sample&quot;</span><span class="hljs-punctuation">,</span></span><br><span class="language-json">    <span class="hljs-attr">&quot;time&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Wed, 21 Oct 2015 18:27:50 GMT&quot;</span></span><br><span class="language-json"><span class="hljs-punctuation">&#125;</span></span><br></code></pre></td></tr></table></figure>
<p>json-parser 是一个<strong>中间件</strong>，可以用来处理 request 和
response 的函数</p>
<h2 id="把应用部署到网上">把应用部署到网上</h2>
<p>因为一些跨域请求默认是被禁止的，故可以使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/expressjs/cors">cors</a>
中间件来运行其他来源的请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cors&quot;</span>);<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());<br></code></pre></td></tr></table></figure>
<p>部署后端</p>
<p>部署前端：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;build:ui&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;rm -rf build &amp;&amp; cd ../part2-notes/ &amp;&amp; npm run build &amp;&amp; cp -r build ../notes-backend&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;deploy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;git push heroku main&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;deploy:full&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;npm run build:ui &amp;&amp; git add . &amp;&amp; git commit -m uibuild &amp;&amp; npm run deploy&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;logs:prod&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;heroku logs --tail&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>因为前端修改为了相对路径（前端和后端部署在了一起），故无法在本地调试前端，可以在本地添加一个代理：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;proxy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:3001&quot;</span><br></code></pre></td></tr></table></figure>
<h2 id="将数据存入-mongodb">将数据存入 MongoDB</h2>
<p>使用的数据库为 MongoDB，常用的服务提供商是 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.mongodb.com/atlas/database">MongoDB Atlas</a></p>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/Automattic/mongoose">mongoose</a>
库，其提供了一个更高级别的 API</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mongoose&quot;</span>);<br><br><span class="hljs-keyword">if</span> (process.<span class="hljs-property">argv</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>    <span class="hljs-string">&quot;Please provide the password as an argument: node mongo.js &lt;password&gt;&quot;</span><br>  );<br>  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">const</span> password = process.<span class="hljs-property">argv</span>[<span class="hljs-number">2</span>];<br><br><span class="hljs-keyword">const</span> url = <span class="hljs-string">`mongodb+srv://fullstack:<span class="hljs-subst">$&#123;password&#125;</span>@cluster0.o1opl.mongodb.net/myFirstDatabase?retryWrites=true&amp;w=majority`</span>;<br><br>mongoose.<span class="hljs-title function_">connect</span>(url);<br><br><span class="hljs-comment">// 定义模式</span><br><span class="hljs-keyword">const</span> noteSchema = <span class="hljs-keyword">new</span> mongoose.<span class="hljs-title class_">Schema</span>(&#123;<br>  <span class="hljs-attr">content</span>: <span class="hljs-title class_">String</span>,<br>  <span class="hljs-attr">date</span>: <span class="hljs-title class_">Date</span>,<br>  <span class="hljs-attr">important</span>: <span class="hljs-title class_">Boolean</span>,<br>&#125;);<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Note</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&quot;Note&quot;</span>, noteSchema); <span class="hljs-comment">// 创建模型</span><br><br><span class="hljs-comment">// 创建一个新的对象（使用构造函数）</span><br><span class="hljs-keyword">const</span> note = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Note</span>(&#123;<br>  <span class="hljs-attr">content</span>: <span class="hljs-string">&quot;HTML is Easy&quot;</span>,<br>  <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),<br>  <span class="hljs-attr">important</span>: <span class="hljs-literal">true</span>,<br>&#125;);<br><br><span class="hljs-comment">// 将对象保存到数据库</span><br>note.<span class="hljs-title function_">save</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;note saved!&quot;</span>);<br>  mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">close</span>();<br>&#125;);<br><br><span class="hljs-comment">// 从数据库中获取对象</span><br><span class="hljs-title class_">Note</span>.<span class="hljs-title function_">find</span>(&#123;&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;<br>  result.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(note);<br>  &#125;);<br>  mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">close</span>();<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>可以修改模式的 <code>toJSON</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript">noteSchema.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;toJSON&quot;</span>, &#123;<br>  <span class="hljs-attr">transform</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">document</span>, returnedObject</span>) =&gt;</span> &#123;<br>    returnedObject.<span class="hljs-property">id</span> = returnedObject.<span class="hljs-property">_id</span>.<span class="hljs-title function_">toString</span>();<br>    <span class="hljs-keyword">delete</span> returnedObject.<span class="hljs-property">_id</span>;<br>    <span class="hljs-keyword">delete</span> returnedObject.<span class="hljs-property">__v</span>;<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>一般使用环境变量，安装 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/motdotla/dotenv">dotenv</a> 库</p>
<p>在 .env 文件中加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs env">MONGODB_URI=mongodb+srv://fullstack:&lt;password&gt;@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority<br>PORT=3001<br></code></pre></td></tr></table></figure>
<p>该文件的信息的使用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;dotenv&quot;</span>).<span class="hljs-title function_">config</span>();<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span>;<br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server running on port <span class="hljs-subst">$&#123;PORT&#125;</span>`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>mongoose 有 <code>findById</code>
方法，获取一个单独的笔记方法如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/notes/:id&quot;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123;<br>  <span class="hljs-title class_">Note</span>.<span class="hljs-title function_">findById</span>(request.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> &#123;<br>    response.<span class="hljs-title function_">json</span>(note);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p><code>findByIdAndDelete</code> 和 <code>findByIdAndUpdate</code>
等同理</p>
<p>最好在每个 <code>.then</code> 块之后使用 <code>.catch</code>
捕捉异常：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)<br>  response.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;malformatted id&#x27;</span> &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>可以进一步把错误处理程序封装到一个中间件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/notes/:id&quot;</span>, <span class="hljs-function">(<span class="hljs-params">request, response, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-title class_">Note</span>.<span class="hljs-title function_">findById</span>(request.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>)<br>    .<span class="hljs-title function_">then</span>()<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title function_">next</span>(error));<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>我们的错误处理程序如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">errorHandler</span> = (<span class="hljs-params">error, request, response, next</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);<br>  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;CastError&quot;</span>)<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;malformatted id&quot;</span> &#125;);<br>  <span class="hljs-title function_">next</span>(error);<br>&#125;;<br><br><span class="hljs-comment">// 这必须是最后一个载入的中间件。</span><br>app.<span class="hljs-title function_">use</span>(errorHandler);<br></code></pre></td></tr></table></figure>
<h2 id="eslint-与代码检查">ESLint 与代码检查</h2>
<p>可以使用 Mongoose 中的验证功能来检查输入格式是否正确：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> noteSchema = <span class="hljs-keyword">new</span> mongoose.<span class="hljs-title class_">Schema</span>(&#123;<br>  <span class="hljs-attr">content</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">minLength</span>: <span class="hljs-number">5</span>,<br>    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>  <span class="hljs-attr">date</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Date</span>,<br>    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>  <span class="hljs-attr">important</span>: <span class="hljs-title class_">Boolean</span>,<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>中间件可以添加一些信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">errorHandler</span> = (<span class="hljs-params">error, request, response, next</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);<br>  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;CastError&quot;</span>)<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;malformatted id&quot;</span> &#125;);<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;ValidationError&quot;</span>)<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> &#125;);<br>  <span class="hljs-title function_">next</span>(error);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>注意 <code>findOneAndUpdate</code> 不会自动验证，可以显示指定：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">Note</span>.<span class="hljs-title function_">findByIdAndUpdate</span>(request.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>, request.<span class="hljs-property">body</span>, &#123;<br>  <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">runValidators</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">context</span>: <span class="hljs-string">&quot;query&quot;</span>,<br>&#125;);<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://eslint.org/">ESlint</a> 是 JavaScript
的静态分析工具</p>
<p>初始化一个默认的 ESlint 配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx eslint --init<br></code></pre></td></tr></table></figure>
<p>该配置保存在 <code>.eslintrc.js</code>
文件中，<code>.eslintignore</code> 文件保存忽略的文件</p>
<p>创建单独的脚本进行 <code>linting</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;lint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eslint .&quot;</span><br></code></pre></td></tr></table></figure>
<h1 id="测试-express-服务端程序-以及用户管理">测试 Express 服务端程序,
以及用户管理</h1>
<h2 id="从后端结构到测试入门">从后端结构到测试入门</h2>
<p>项目的结构一般如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs file">├── index.js<br>├── app.js<br>├── build<br>│   └── ...<br>├── controllers<br>│   └── notes.js<br>├── models<br>│   └── note.js<br>├── package-lock.json<br>├── package.json<br>├── utils<br>│   ├── config.js<br>│   ├── logger.js<br>│   └── middleware.js<br></code></pre></td></tr></table></figure>
<p><code>utils/logger.js</code> 文件中存放打印模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">info</span> = (<span class="hljs-params">...params</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(...params);<br>&#125;;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">error</span> = (<span class="hljs-params">...params</span>) =&gt; &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(...params);<br>&#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123; info, error &#125;;<br></code></pre></td></tr></table></figure>
<p><code>utils/config.js</code> 文件中处理环境变量：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;dotenv&quot;</span>).<span class="hljs-title function_">config</span>();<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MONGODB_URI</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">MONGODB_URI</span>;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123; <span class="hljs-variable constant_">MONGODB_URI</span>, <span class="hljs-variable constant_">PORT</span> &#125;;<br></code></pre></td></tr></table></figure>
<p><code>utils/middleware.js</code> 模块中是自定义的中间件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./logger&#x27;</span>)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">requestLogger</span> = (<span class="hljs-params">request, response, next</span>) =&gt; &#123;...&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">unknownEndpoint</span> = (<span class="hljs-params">request, response</span>) =&gt; &#123; response.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;unknown endpoint&#x27;</span> &#125;) &#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">errorHandler</span> = (<span class="hljs-params">error, request, response, next</span>) =&gt; &#123;...&#125;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123; requestLogger, unknownEndpoint, errorHandler &#125;<br></code></pre></td></tr></table></figure>
<p>与 <code>notes</code> 相关的路由现在都在
<code>controllers/notes.js</code> 模块中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> notesRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>).<span class="hljs-title class_">Router</span>()<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Note</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../models/note&#x27;</span>)<br><br>notesRouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response</span>) =&gt;</span> &#123;...&#125;)<br>notesRouter.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response, next</span>) =&gt;</span> &#123;...&#125;)<br>notesRouter.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response, next</span>) =&gt;</span> &#123;...&#125;)<br>notesRouter.<span class="hljs-title function_">delete</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response, next</span>) =&gt;</span> &#123;...&#125;)<br>notesRouter.<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">request, response, next</span>) =&gt;</span> &#123;...&#125;)<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = notesRouter<br></code></pre></td></tr></table></figure>
<p>这些路由对象相当于是中间件，注意 <code>/api/notes/:id</code>
被缩短为了 <code>/:id</code></p>
<p><code>models/note.js</code> 文件定义了 Mongoose 模式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mongoose&#x27;</span>)<br><br><span class="hljs-keyword">const</span> noteSchema = <span class="hljs-keyword">new</span> mongoose.<span class="hljs-title class_">Schema</span>(&#123;...&#125;)<br><br>noteSchema.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;toJSON&#x27;</span>, &#123;...&#125;)<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;Note&#x27;</span>, noteSchema)<br></code></pre></td></tr></table></figure>
<p><code>index.js</code> 文件用于启动应用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> app = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./app&quot;</span>); <span class="hljs-comment">// the actual Express application</span><br><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>);<br><span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./utils/config&quot;</span>);<br><span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./utils/logger&quot;</span>);<br><br><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(app);<br><br>server.<span class="hljs-title function_">listen</span>(config.<span class="hljs-property">PORT</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Server running on port <span class="hljs-subst">$&#123;config.PORT&#125;</span>`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p><code>app.js</code> 使用到了大量的中间件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./utils/config&quot;</span>);<br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cors&quot;</span>);<br><span class="hljs-keyword">const</span> notesRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./controllers/notes&quot;</span>);<br><span class="hljs-keyword">const</span> middleware = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./utils/middleware&quot;</span>);<br><span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./utils/logger&quot;</span>);<br><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mongoose&quot;</span>);<br><br>logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;connecting to&quot;</span>, config.<span class="hljs-property">MONGODB_URI</span>);<br><br>mongoose.<span class="hljs-title function_">connect</span>(config.<span class="hljs-property">MONGODB_URI</span>);<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;build&quot;</span>));<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br>app.<span class="hljs-title function_">use</span>(middleware.<span class="hljs-property">requestLogger</span>);<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;/api/notes&quot;</span>, notesRouter);<br><br>app.<span class="hljs-title function_">use</span>(middleware.<span class="hljs-property">unknownEndpoint</span>);<br>app.<span class="hljs-title function_">use</span>(middleware.<span class="hljs-property">errorHandler</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = app;<br></code></pre></td></tr></table></figure>
<p><code>utils/for_testing.js</code> 存放自动化测试文件，如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">reverse</span> = (<span class="hljs-params">string</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> string.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">average</span> = (<span class="hljs-params">array</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reducer</span> = (<span class="hljs-params">sum, item</span>) =&gt; &#123;<br>    <span class="hljs-keyword">return</span> sum + item;<br>  &#125;;<br>  <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">reduce</span>(reducer, <span class="hljs-number">0</span>) / array.<span class="hljs-property">length</span>;<br>&#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123; reverse, average &#125;;<br></code></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/jestjs/jest">jest</a> 作为测试库</p>
<p>添加脚本：<code>"test": "jest --verbose"</code></p>
<p>指定执行环境为 Node：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;jest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;testEnvironment&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>测试文件在 <code>test/reverse.test.js</code> 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> reverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../utils/for_testing&quot;</span>).<span class="hljs-property">reverse</span>;<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;reverse of a&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">reverse</span>(<span class="hljs-string">&quot;a&quot;</span>);<br>  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&quot;a&quot;</span>);<br>&#125;);<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;reverse of react&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">reverse</span>(<span class="hljs-string">&quot;react&quot;</span>);<br>  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&quot;tcaer&quot;</span>);<br>&#125;);<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;reverse of releveler&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">reverse</span>(<span class="hljs-string">&quot;releveler&quot;</span>);<br>  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&quot;releveler&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>
<h2 id="测试后端应用">测试后端应用</h2>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kentcdodds/cross-env">cross-env</a>
包来实现跨平台兼容，并使用 <code>NODE_ENV</code>
环境变量来定义应用的执行模式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cross-env NODE_ENV=production node index.js&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;dev&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cross-env NODE_ENV=development nodemon index.js&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cross-env NODE_ENV=test jest --verbose --runInBand&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br></code></pre></td></tr></table></figure>
<p>为测试设置单独的数据库：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MONGODB_URI</span> =<br>  process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&quot;test&quot;</span><br>    ? process.<span class="hljs-property">env</span>.<span class="hljs-property">TEST_MONGODB_URI</span><br>    : process.<span class="hljs-property">env</span>.<span class="hljs-property">MONGODB_URI</span>;<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">TEST_MONGODB_URI=mongodb+srv://fullstack:&lt;password&gt;@cluster0.o1opl.mongodb.net/testNoteApp?retryWrites=<span class="hljs-literal">true</span>&amp;w=majority<br></code></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/ladjs/supertest">supertest</a>
包测试 API</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mongoose&quot;</span>);<br><span class="hljs-keyword">const</span> supertest = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;supertest&quot;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../app&quot;</span>);<br><br><span class="hljs-keyword">const</span> api = supertest(app);<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;notes are returned as json&quot;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">await</span> api<br>    .<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/notes&quot;</span>)<br>    .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>)<br>    .<span class="hljs-title function_">expect</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-regexp">/application\/json/</span>);<br>&#125;);<br><br><span class="hljs-comment">// 在所有测试完成后关闭连接</span><br><span class="hljs-title function_">afterAll</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">close</span>();<br>&#125;);<br></code></pre></td></tr></table></figure>
<p><code>expect(response.body).toHaveLength(2)</code> 和
<code>expect(response.body[0].content).toBe('HTML is easy')</code>
等方便比较内容</p>
<p>类似的，还有 <code>beforeEach()</code> 函数在所有测试开始之前执行</p>
<p>可以使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/davidbanham/express-async-errors">express-async-errors</a>
来避免代码中大量出现的 <code>try...catch...</code> 块</p>
<h2 id="用户管理">用户管理</h2>
<p>Mongo 不是关系型数据库，故本身不支持 join 操作，只能自定义模式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> mongoose.<span class="hljs-title class_">Schema</span>(&#123;<br>  <span class="hljs-attr">username</span>: <span class="hljs-title class_">String</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>,<br>  <span class="hljs-attr">passwordHash</span>: <span class="hljs-title class_">String</span>,<br>  <span class="hljs-attr">notes</span>: [<br>    &#123;<br>      <span class="hljs-attr">type</span>: mongoose.<span class="hljs-property">Schema</span>.<span class="hljs-property">Types</span>.<span class="hljs-property">ObjectId</span>,<br>      <span class="hljs-attr">ref</span>: <span class="hljs-string">&quot;Note&quot;</span>,<br>    &#125;,<br>  ],<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>另一边类似的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> noteSchema = <span class="hljs-keyword">new</span> mongoose.<span class="hljs-title class_">Schema</span>(&#123;<br>  <span class="hljs-attr">content</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,<br>    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">minlength</span>: <span class="hljs-number">5</span>,<br>  &#125;,<br>  <span class="hljs-attr">date</span>: <span class="hljs-title class_">Date</span>,<br>  <span class="hljs-attr">important</span>: <span class="hljs-title class_">Boolean</span>,<br><br>  <span class="hljs-attr">user</span>: &#123;<br>    <span class="hljs-attr">type</span>: mongoose.<span class="hljs-property">Schema</span>.<span class="hljs-property">Types</span>.<span class="hljs-property">ObjectId</span>,<br>    <span class="hljs-attr">ref</span>: <span class="hljs-string">&quot;User&quot;</span>,<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>安装 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/kelektiv/node.bcrypt.js">bcrypt</a>
软件包来生成密码散列：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> saltRounds = <span class="hljs-number">10</span>;<br><span class="hljs-keyword">const</span> passwordHash = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">hash</span>(password, saltRounds);<br></code></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/mongoose-unique-validator/mongoose-unique-validator">mongoose-unique-validator</a>
包来实现唯一性检查</p>
<p>Mongoose 库实现了集合之间的连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">find</span>(&#123;&#125;).<span class="hljs-title function_">populate</span>(<span class="hljs-string">&quot;notes&quot;</span>);<br></code></pre></td></tr></table></figure>
<h2 id="密钥认证">密钥认证</h2>
<p>在后台实现基于令牌的认证的支持</p>
<p>安装 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/auth0/node-jsonwebtoken">jsonwebtoken</a>
库</p>
<p>登录功能的代码放在 <code>controllers/login.js</code> 文件中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;jsonwebtoken&quot;</span>);<br><span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;bcrypt&quot;</span>);<br><span class="hljs-keyword">const</span> loginRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>).<span class="hljs-title class_">Router</span>();<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../models/user&quot;</span>);<br><br>loginRouter.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">async</span> (request, response) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; username, password &#125; = request.<span class="hljs-property">body</span>;<br><br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>(&#123; username &#125;);<br>  <span class="hljs-keyword">const</span> passwordCorrect =<br>    user === <span class="hljs-literal">null</span> ? <span class="hljs-literal">false</span> : <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">compare</span>(password, user.<span class="hljs-property">passwordHash</span>);<br><br>  <span class="hljs-keyword">if</span> (!(user &amp;&amp; passwordCorrect))<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;invalid username or password&quot;</span> &#125;);<br><br>  <span class="hljs-keyword">const</span> userForToken = &#123; <span class="hljs-attr">username</span>: user.<span class="hljs-property">username</span>, <span class="hljs-attr">id</span>: user.<span class="hljs-property">_id</span> &#125;;<br><br>  <span class="hljs-keyword">const</span> token = jwt.<span class="hljs-title function_">sign</span>(<br>    userForToken,<br>    process.<span class="hljs-property">env</span>.<span class="hljs-property">SECRET</span>,<br>    &#123; <span class="hljs-attr">expiresIn</span>: <span class="hljs-number">60</span> * <span class="hljs-number">60</span> &#125; <span class="hljs-comment">// 一个小时过期</span><br>  );<br><br>  response<br>    .<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>)<br>    .<span class="hljs-title function_">send</span>(&#123; token, <span class="hljs-attr">username</span>: user.<span class="hljs-property">username</span>, <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span> &#125;);<br>&#125;);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = loginRouter;<br></code></pre></td></tr></table></figure>
<p>将令牌从浏览器发送到服务器要使用授权头，有几种认证方案，这里使用
Bearer 方案，检验的方法是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getTokenFrom</span> = request =&gt; &#123;<br>  <span class="hljs-keyword">const</span> authorization = request.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;authorization&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (authorization &amp;&amp; authorization.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;bearer &#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> authorization.<span class="hljs-title function_">substring</span>(<span class="hljs-number">7</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>&#125;<br><br>notesRouter.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">async</span> (request, response) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> body = request.<span class="hljs-property">body</span><br>  <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getTokenFrom</span>(request)<br>  <span class="hljs-keyword">const</span> decodedToken = jwt.<span class="hljs-title function_">verify</span>(token, process.<span class="hljs-property">env</span>.<span class="hljs-property">SECRET</span>)<br>  <span class="hljs-keyword">if</span> (!decodedToken.<span class="hljs-property">id</span>) &#123;<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;token missing or invalid&#x27;</span> &#125;)<br>  &#125;<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findById</span>(decodedToken.<span class="hljs-property">id</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>发送要加上头：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-attribute">Authorization</span><span class="hljs-punctuation">: </span>Bearer eyJhbGciOiJIUzI1NiIsInR5c2VybmFtZSI6Im1sdXVra2FpIiwiaW<br></code></pre></td></tr></table></figure>
<h1 id="测试-react-应用">测试 React 应用</h1>
<h2 id="完成前台的登录功能">完成前台的登录功能</h2>
<p>有条件地渲染登录窗口和笔记窗口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  user === <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-title function_">loginForm</span>();<br>&#125;<br>&#123;<br>  user !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-title function_">noteForm</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>登录成功的用户信息储存在 token 中，故 noteService 模块中应添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> token = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">setToken</span> = (<span class="hljs-params">newToken</span>) =&gt; &#123;<br>  token = <span class="hljs-string">`bearer <span class="hljs-subst">$&#123;newToken&#125;</span>`</span>;<br>&#125;;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">create</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">newObject</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> config = &#123; <span class="hljs-attr">headers</span>: &#123; <span class="hljs-title class_">Authorization</span>: token &#125; &#125;;<br>  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(baseUrl, newObject, config);<br>  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>每次刷新后用户信息就消失了，可以通过将登录信息保存到本地存储中解决：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;loggedNoteappUser&quot;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user));<br></code></pre></td></tr></table></figure>
<p>使用<strong>效果钩子</strong>在进入页面时查找本地存储</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> loggedUserJSON = <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;loggedNoteappUser&quot;</span>);<br>  <span class="hljs-keyword">if</span> (loggedUserJSON) &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(loggedUserJSON);<br>    <span class="hljs-title function_">setUser</span>(user);<br>    noteService.<span class="hljs-title function_">setToken</span>(user.<span class="hljs-property">token</span>);<br>  &#125;<br>&#125;, []);<br></code></pre></td></tr></table></figure>
<h2 id="props.children-与-proptypes">props.children 与 proptypes</h2>
<p>一个可以展开和折叠的组件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">Togglable</span> = (<span class="hljs-params">props</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [visible, setVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> hideWhenVisible = &#123; <span class="hljs-attr">display</span>: visible ? <span class="hljs-string">&quot;none&quot;</span> : <span class="hljs-string">&quot;&quot;</span> &#125;;<br>  <span class="hljs-keyword">const</span> showWhenVisible = &#123; <span class="hljs-attr">display</span>: visible ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;none&quot;</span> &#125;;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleVisibility</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setVisible</span>(!visible);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;hideWhenVisible&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;toggleVisibility&#125;</span>&gt;</span>&#123;props.buttonLabel&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;showWhenVisible&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;props.children&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;toggleVisibility&#125;</span>&gt;</span>cancel<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Togglable</span>;<br></code></pre></td></tr></table></figure>
<p>如果想要在 Togglable 组件之外访问 visible 变量，可以使用 React 的 ref
机制：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; useState, useEffect, useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">const</span> noteFormRef = <span class="hljs-title function_">useRef</span>();<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">noteForm</span> = (<span class="hljs-params"></span>) =&gt; (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Togglable</span> <span class="hljs-attr">buttonLabel</span>=<span class="hljs-string">&quot;new note&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;noteFormRef&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">NoteForm</span> <span class="hljs-attr">createNote</span>=<span class="hljs-string">&#123;addNote&#125;</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Togglable</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure>
<p>Togglable 组件中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; useState, forwardRef, useImperativeHandle &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Togglable</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> &#123; toggleVisibility &#125;;<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>通过 <code>noteFormRef.current.toggleVisibility()</code> 隐藏表单</p>
<p>可以使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/facebook/prop-types">prop-types</a>
包定义组件的预期和要求，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">PropTypes</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;prop-types&#x27;</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Togglable</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;...&#125;)<br><span class="hljs-title class_">Togglable</span>.<span class="hljs-property">propTypes</span> = &#123; <span class="hljs-attr">buttonLabel</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>.<span class="hljs-property">isRequired</span> &#125;<br></code></pre></td></tr></table></figure>
<h2 id="测试-react-应用-1">测试 React 应用</h2>
<p>安装一些有用的测试库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install --save-dev @testing-library/react @testing-library/jest-dom<br></code></pre></td></tr></table></figure>
<p>测试是否渲染了笔记内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;@testing-library/jest-dom/extend-expect&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; render, screen &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@testing-library/react&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Note</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./Note&quot;</span>;<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&quot;renders content&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> note = &#123;<br>    <span class="hljs-attr">content</span>: <span class="hljs-string">&quot;Component testing is done with react-testing-library&quot;</span>,<br>    <span class="hljs-attr">important</span>: <span class="hljs-literal">true</span>,<br>  &#125;;<br>  <span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Note</span> <span class="hljs-attr">note</span>=<span class="hljs-string">&#123;note&#125;</span> /&gt;</span></span>); <span class="hljs-comment">// 渲染</span><br>  <span class="hljs-keyword">const</span> element = screen.<span class="hljs-title function_">getByText</span>(<br>    <span class="hljs-string">&quot;Component testing is done with react-testing-library&quot;</span><br>  );<br>  <span class="hljs-title function_">expect</span>(element).<span class="hljs-title function_">toBeDefined</span>();<br>  <span class="hljs-comment">// 令一种方法，使用 CSS-selectors 实现</span><br>  <span class="hljs-keyword">const</span> &#123; container &#125; = <span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Note</span> <span class="hljs-attr">note</span>=<span class="hljs-string">&#123;note&#125;</span> /&gt;</span></span>);<br>  <span class="hljs-keyword">const</span> div = container.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.note&quot;</span>);<br>  <span class="hljs-title function_">expect</span>(div).<span class="hljs-title function_">toHaveTextContent</span>(<br>    <span class="hljs-string">&quot;Component testing is done with react-testing-library&quot;</span><br>  );<br>&#125;);<br></code></pre></td></tr></table></figure>
<p><code>screen.debug()</code> 命令可以将一个组件的 HTML 打印到终端</p>
<p>在处理事件时，使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://testing-library.com/docs/user-event/intro">user-event</a>
库</p>
<p>事件处理程序是一个用 Jest 定义的 mock 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> mockHandler = jest.<span class="hljs-title function_">fn</span>()copy<br></code></pre></td></tr></table></figure>
<p>一个 session 被启动以与渲染的组件进行交互。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> user = userEvent.<span class="hljs-title function_">setup</span>();<br></code></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> user.<span class="hljs-title function_">click</span>(button);<br><span class="hljs-keyword">const</span> button = screen.<span class="hljs-title function_">getByText</span>(<span class="hljs-string">&quot;make not important&quot;</span>);<br></code></pre></td></tr></table></figure>
<h2 id="端到端测试">端到端测试</h2>
<p>前面讲的都是单元测试，实际上也可以进行整体测试</p>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cypress.io/">Cypress</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;Note app&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;front page can be opened&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    cy.<span class="hljs-title function_">visit</span>(<span class="hljs-string">&quot;http://localhost:3000&quot;</span>);<br>    cy.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;Notes&quot;</span>);<br>    cy.<span class="hljs-title function_">contains</span>(<br>      <span class="hljs-string">&quot;Note app, Department of Computer Science, University of Helsinki 2022&quot;</span><br>    );<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>向窗体中输入信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&quot;Note app&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">it</span>(<span class="hljs-string">&quot;user can log in&quot;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    cy.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;login&quot;</span>).<span class="hljs-title function_">click</span>();<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;#username&quot;</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&quot;mluukkai&quot;</span>);<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;#password&quot;</span>).<span class="hljs-title function_">type</span>(<span class="hljs-string">&quot;salainen&quot;</span>);<br>    cy.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;#login-button&quot;</span>).<span class="hljs-title function_">click</span>();<br>    cy.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;Matti Luukkainen logged in&quot;</span>);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>
<h1 id="利用-redux-进行状态管理">利用 Redux 进行状态管理</h1>
<h2 id="flux-架构与-redux">Flux 架构与 Redux</h2>
<p>在 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://redux.js.org/">Redux</a> 中，状态被完全从 React
组件中分离出来，进入它自己的存储</p>
<p>存储器的状态通过动作改变，可以自定义一个动作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">&#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;INCREMENT&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>动作对应用状态的影响通过 reducer 实现，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">counterReducer</span> = (<span class="hljs-params">state = <span class="hljs-number">0</span>, action</span>) =&gt; &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;INCREMENT&quot;</span>:<br>      <span class="hljs-keyword">return</span> state + <span class="hljs-number">1</span>;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>reducer 作为创建存储的一个参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(counterReducer);<br></code></pre></td></tr></table></figure>
<p>操作则使用 <code>dispatch()</code> 方法，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">store.<span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;INCREMENT&quot;</span> &#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-title function_">getState</span>()); <span class="hljs-comment">// 获取状态</span><br></code></pre></td></tr></table></figure>
<p>注意 reducer 必须是一个<strong>纯函数</strong></p>
<p>让应用能够访问存储的方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Provider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-redux&quot;</span>;<br><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;root&quot;</span>)).<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure>
<p>现在使用 <code>useDispatch()</code> 分派动作，相应的，使用
<code>useSelector</code> 获取数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-redux&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleImportance</span> = (<span class="hljs-params">id</span>) =&gt; &#123;<br>    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">toggleImportanceOf</span>(id));<br>  &#125;;<br><br>  <span class="hljs-keyword">const</span> notes = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state);<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="再来点-reducers">再来点 reducers</h2>
<p>可以使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://redux-toolkit.js.org/">Redux Toolkit</a>
组合两个 reducer：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">configureStore</span>(&#123;<br>  <span class="hljs-attr">reducer</span>: &#123;<br>    <span class="hljs-attr">notes</span>: noteReducer,<br>    <span class="hljs-attr">filter</span>: filterReducer,<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>用 createSlice 函数创建 reducer 和相应的动作创建器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> noteSlice = <span class="hljs-title function_">createSlice</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;notes&quot;</span>,<br>  initialState,<br>  <span class="hljs-attr">reducers</span>: &#123;<br>    <span class="hljs-title function_">createNote</span>(<span class="hljs-params">state, action</span>) &#123;<br>      <span class="hljs-keyword">const</span> content = action.<span class="hljs-property">payload</span>;<br>      state.<span class="hljs-title function_">push</span>(&#123;<br>        content,<br>        <span class="hljs-attr">important</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-attr">id</span>: <span class="hljs-title function_">generateId</span>(),<br>      &#125;);<br>    &#125;,<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>注意到 <code>state</code> 可变了</p>
<h2 id="在-redux-应用中与后端通信">在 Redux 应用中与后端通信</h2>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/reduxjs/redux-thunk">Redux Thunk</a>
库来实现动作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">initializeNotes</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (dispatch) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> notes = <span class="hljs-keyword">await</span> noteService.<span class="hljs-title function_">getAll</span>();<br>    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">setNotes</span>(notes));<br>  &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="react-queryusereducer-和-context">React Query，useReducer 和
context</h2>
<p>用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://tanstack.com/query/latest/docs/react/">React
Query</a> 存储并管理从服务器检索的数据</p>
<p>将这个库中的函数传递给整个应用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">QueryClient</span>, <span class="hljs-title class_">QueryClientProvider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-query&quot;</span>;<br><span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>();<br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;root&quot;</span>)).<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">QueryClientProvider</span> <span class="hljs-attr">client</span>=<span class="hljs-string">&#123;queryClient&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">QueryClientProvider</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure>
<p>获取方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> result = <span class="hljs-title function_">useQuery</span>(<span class="hljs-string">&quot;notes&quot;</span>, <span class="hljs-function">() =&gt;</span><br>  axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;http://localhost:3001/notes&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-property">data</span>)<br>);<br></code></pre></td></tr></table></figure>
<p>使用 mutation 创建新笔记并在本地插入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> newNoteMutation = <span class="hljs-title function_">useMutation</span>(createNote, &#123;<br>    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">newNote</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> notes = queryClient.<span class="hljs-title function_">getQueryData</span>(<span class="hljs-string">&quot;notes&quot;</span>);<br>      queryClient.<span class="hljs-title function_">setQueryData</span>(<span class="hljs-string">&quot;notes&quot;</span>, notes.<span class="hljs-title function_">concat</span>(newNote));<br>    &#125;,<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><code>useReducer</code> 提供了为应用创建状态的机制：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> [counter, counterDispatch] = <span class="hljs-title function_">useReducer</span>(counterReducer, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>
<p>使用 <code>createContext()</code> 创建
context，这样就不需要层层传递给各组件了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">CounterContext</span>.<span class="hljs-property">Provider</span> value=&#123;[counter, counterDispatch]&#125;&gt;<br>  ...<br>&lt;/<span class="hljs-title class_">CounterContext</span>.<span class="hljs-property">Provider</span>&gt;<br></code></pre></td></tr></table></figure>
<p>其他组件可以使用 <code>useContext</code> 访问</p>
<h1 id="react-router自定义-hook利用-css-和-webpack-给-app-添加样式">React
router、自定义 hook，利用 CSS 和 webpack 给 app 添加样式</h1>
<h2 id="react-router">React-router</h2>
<p>使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://reactrouter.com/">React Router</a>
库生成导航栏：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>, <span class="hljs-title class_">Link</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-router-dom&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> padding = &#123;<br>    <span class="hljs-attr">padding</span>: <span class="hljs-number">5</span>,<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;padding&#125;</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span></span><br><span class="language-xml">          home</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;padding&#125;</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/notes&quot;</span>&gt;</span></span><br><span class="language-xml">          notes</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;padding&#125;</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/users&quot;</span>&gt;</span></span><br><span class="language-xml">          users</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/notes&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Notes</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/users&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Users</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>Note app, Department of Computer Science 2022<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span><br>  );<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>可以添加参数路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">&quot;/notes/:id&quot;</span> element=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Note</span> <span class="hljs-attr">notes</span>=<span class="hljs-string">&#123;notes&#125;</span> /&gt;</span></span>&#125; /&gt;<br></code></pre></td></tr></table></figure>
<p>使用 <code>useNavigate()</code> 和 <code>navigate('/')</code>
可以手动导航</p>
<p>如果一个用户没有登录，则会被重定向到登录页面：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">Route</span><br>  path=<span class="hljs-string">&quot;/users&quot;</span><br>  element=&#123;user ? <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Users</span> /&gt;</span></span> : <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">replace</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/login&quot;</span> /&gt;</span></span>&#125;<br>/&gt;<br></code></pre></td></tr></table></figure>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://reactrouter.com/en/main/hooks/use-match">useMatch</a>
钩子可以计算出所需 id：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> match = <span class="hljs-title function_">useMatch</span>(<span class="hljs-string">&quot;/notes/:id&quot;</span>);<br><span class="hljs-keyword">const</span> note = match<br>  ? notes.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">note</span>) =&gt;</span> note.<span class="hljs-property">id</span> === <span class="hljs-title class_">Number</span>(match.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>))<br>  : <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure>
<h2 id="自定义-hooks">自定义 hooks</h2>
<p>我们也可以自定义钩子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useField</span> = (<span class="hljs-params">type</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&quot;&quot;</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onChange</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>    <span class="hljs-title function_">setValue</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);<br>  &#125;;<br>  <span class="hljs-keyword">return</span> &#123; type, value, onChange &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="样式进阶">样式进阶</h2>
<p>先介绍 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://getbootstrap.com/">Bootstrap</a>，使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://react-bootstrap.github.io/">react-bootstrap</a>
软件包，并在 <code>index.html</code> 的 <code>head</code> 中加载
CSS：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span></span><br><span class="hljs-tag">    <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>应用的所有内容在容器中渲染，给应用的根 div 元素加上 container
类属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span>// ...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>有<a target="_blank" rel="external nofollow noopener noreferrer" href="https://react-bootstrap.github.io/docs/components/table/">表格</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://getbootstrap.com/docs/4.1/components/forms/">表单</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://getbootstrap.com/docs/4.1/components/alerts/">通知</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://getbootstrap.com/docs/4.1/components/navbar/">导航栏</a>等</p>
<p>接下来是 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://mui.com/">MaterialUI</a> React
库，要安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install @mui/material @emotion/react @emotion/styled<br></code></pre></td></tr></table></figure>
<p><code>index.html</code> 中添加：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">link</span></span><br><span class="hljs-tag">    <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&amp;display=swap&quot;</span></span><br><span class="hljs-tag">  /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>渲染方式是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Container</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@mui/material&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Container</span>&gt;</span>// ...<span class="hljs-tag">&lt;/<span class="hljs-name">Container</span>&gt;</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>同样有<a target="_blank" rel="external nofollow noopener noreferrer" href="https://mui.com/material-ui/react-table/#simple-table">表格</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://mui.com/material-ui/react-text-field/">文本框</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://mui.com/material-ui/api/button/">按钮</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://mui.com/material-ui/react-alert/">Alert</a>，<a target="_blank" rel="external nofollow noopener noreferrer" href="https://mui.com/material-ui/react-app-bar/">AppBar</a></p>
<p>还可以使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.styled-components.com/">styled
components</a> 库提供的方式定义样式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;styled-components&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Input</span> = styled.<span class="hljs-property">input</span><span class="hljs-string">`</span><br><span class="hljs-string">  margin: 0.25em;</span><br><span class="hljs-string">`</span>;<br></code></pre></td></tr></table></figure>
<p>然后正常使用即可</p>
<h2 id="webpack">Webpack</h2>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://webpack.js.org/">webpack</a> 可用于创建 app</p>
<p>一个 <code>webpack.config.js</code> 文件的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;path&quot;</span>);<br><br><span class="hljs-keyword">const</span> config = &#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-string">&quot;./src/index.js&quot;</span>,<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;build&quot;</span>),<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&quot;main.js&quot;</span>,<br>  &#125;,<br>&#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = config;<br></code></pre></td></tr></table></figure>
<p>可以使用 loaders 来通知 webpack 在捆绑前需要处理的文件，例如将
<code>.jsx</code> 文件转化为普通的 <code>.js</code> 文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>        <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;babel-loader&#x27;</span>,<br>        <span class="hljs-attr">options</span>: &#123;<br>            <span class="hljs-attr">presets</span>: [<span class="hljs-string">&#x27;@babel/preset-react&#x27;</span>],<br>        &#125;,<br>      &#125;,<br>    ],<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>还需要安装并引入 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.npmjs.com/package/core-js">core-js</a> 和 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.npmjs.com/package/regenerator-runtime">regenerator-runtime</a></p>
<p>当使用 CSS 时，我们必须使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://webpack.js.org/loaders/css-loader/">css</a> 和 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://webpack.js.org/loaders/style-loader/">style</a>
加载器。</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://webpack.js.org/configuration/devtool/">source
map</a> 有助于我们看到源代码</p>
<h2 id="各种各样的-class-components">各种各样的 Class components</h2>
<p>React 元素构成了一个虚拟 DOM</p>
<p><code>npm-check-updates</code> 可以用来检查依赖的更新</p>
<h1 id="graphql">GraphQL</h1>
<h2 id="graphql-服务器">GraphQL 服务器</h2>
<p>REST 是基于资源的，对资源的所有操作通过对其 URL 的 HTTP
请求完成。</p>
<p>但是 GraphQL 的所有查询都被发送到一个地址，类型是 POST</p>
<p>一个定义的模式的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">type <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>!<br>  <span class="hljs-attr">phone</span>: <span class="hljs-title class_">String</span><br>  <span class="hljs-attr">street</span>: <span class="hljs-title class_">String</span>!<br>  <span class="hljs-attr">city</span>: <span class="hljs-title class_">String</span>!<br>  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>!<br>&#125;<br><br>type <span class="hljs-title class_">Query</span> &#123;<br>  <span class="hljs-attr">personCount</span>: <span class="hljs-title class_">Int</span>!<br>  <span class="hljs-attr">allPersons</span>: [<span class="hljs-title class_">Person</span>!]!<br>  <span class="hljs-title function_">findPerson</span>(<span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>!): <span class="hljs-title class_">Person</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>查询：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">query &#123;<br>  allPersons &#123;<br>    name<br>    phone<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>返回值：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;allPersons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Arto Hellas&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;040-123543&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Matti Luukkainen&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;040-432342&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Venla Ruuska&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>也可以带有参数</p>
<p>实现服务器使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.apollographql.com/docs/apollo-server/">Apollo
Server</a></p>
<p>定义模式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; <span class="hljs-title class_">ApolloServer</span>, gql &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;apollo-server&quot;</span>);<br><br><span class="hljs-keyword">const</span> typeDefs = gql`<span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">type</span> Person <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    <span class="hljs-symbol">name</span><span class="hljs-punctuation">:</span> String<span class="hljs-punctuation">!</span></span><br><span class="language-graphql">    <span class="hljs-symbol">phone</span><span class="hljs-punctuation">:</span> String</span><br><span class="language-graphql">    <span class="hljs-symbol">street</span><span class="hljs-punctuation">:</span> String<span class="hljs-punctuation">!</span></span><br><span class="language-graphql">    <span class="hljs-symbol">city</span><span class="hljs-punctuation">:</span> String<span class="hljs-punctuation">!</span></span><br><span class="language-graphql">    <span class="hljs-symbol">id</span><span class="hljs-punctuation">:</span> ID<span class="hljs-punctuation">!</span></span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">type</span> <span class="hljs-keyword">Query</span> <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    <span class="hljs-symbol">personCount</span><span class="hljs-punctuation">:</span> Int<span class="hljs-punctuation">!</span></span><br><span class="language-graphql">    <span class="hljs-symbol">allPersons</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>Person<span class="hljs-punctuation">!</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">!</span></span><br><span class="language-graphql">    findPerson<span class="hljs-punctuation">(</span><span class="hljs-symbol">name</span><span class="hljs-punctuation">:</span> String<span class="hljs-punctuation">!</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">:</span> Person</span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">`</span>;<br><br><span class="hljs-keyword">const</span> resolvers = &#123;<br>  <span class="hljs-title class_">Query</span>: &#123;<br>    <span class="hljs-attr">personCount</span>: <span class="hljs-function">() =&gt;</span> persons.<span class="hljs-property">length</span>,<br>    <span class="hljs-attr">allPersons</span>: <span class="hljs-function">() =&gt;</span> persons,<br>    <span class="hljs-attr">findPerson</span>: <span class="hljs-function">(<span class="hljs-params">root, args</span>) =&gt;</span> persons.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">name</span> === args.<span class="hljs-property">name</span>),<br>  &#125;,<br>&#125;;<br><br><span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApolloServer</span>(&#123;<br>  typeDefs,<br>  resolvers,<br>&#125;);<br><br>server.<span class="hljs-title function_">listen</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">&#123; url &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server ready at <span class="hljs-subst">$&#123;url&#125;</span>`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>对象之间也可以组合，如模式为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">type <span class="hljs-title class_">Address</span> &#123;<br>  <span class="hljs-attr">street</span>: <span class="hljs-title class_">String</span>!<br>  <span class="hljs-attr">city</span>: <span class="hljs-title class_">String</span>!<br>&#125;<br><br>type <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>!<br>  <span class="hljs-attr">address</span>: <span class="hljs-title class_">Address</span>!<br>  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>!<br>&#125;<br></code></pre></td></tr></table></figure>
<p>所有引起变化的操作通过 mutation 完成，如添加一个新人：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js">type <span class="hljs-title class_">Mutation</span> &#123;<br>  <span class="hljs-title function_">addPerson</span>(<br>    <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>!<br>    <span class="hljs-attr">phone</span>: <span class="hljs-title class_">String</span><br>    <span class="hljs-attr">street</span>: <span class="hljs-title class_">String</span>!<br>    <span class="hljs-attr">city</span>: <span class="hljs-title class_">String</span>!<br>  ): <span class="hljs-title class_">Person</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以使用 Apollo 的错误处理机制，如抛出
<code>throw new UserInputError('Name must be unique', &#123;invalidArgs: args.name, &#125;)</code></p>
<p>GraphQL 支持枚举类型：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">enum <span class="hljs-title class_">YesNo</span> &#123;<br>  <span class="hljs-variable constant_">YES</span><br>  <span class="hljs-variable constant_">NO</span><br>&#125;<br><br>type <span class="hljs-title class_">Query</span> &#123;<br>  <span class="hljs-attr">personCount</span>: <span class="hljs-title class_">Int</span>!<br><br>  <span class="hljs-title function_">allPersons</span>(<span class="hljs-attr">phone</span>: <span class="hljs-title class_">YesNo</span>): [<span class="hljs-title class_">Person</span>!]!<br>  <span class="hljs-title function_">findPerson</span>(<span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>!): <span class="hljs-title class_">Person</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="react-与-graphql">React 与 GraphQL</h2>
<p>客户端使用 <code>ApolloProvider</code> 包装 APP 组件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./App&quot;</span>;<br><br><span class="hljs-keyword">import</span> &#123;<br>  <span class="hljs-title class_">ApolloClient</span>,<br>  <span class="hljs-title class_">ApolloProvider</span>,<br>  <span class="hljs-title class_">HttpLink</span>,<br>  <span class="hljs-title class_">InMemoryCache</span>,<br>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@apollo/client&quot;</span>;<br><br><span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApolloClient</span>(&#123;<br>  <span class="hljs-attr">cache</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryCache</span>(),<br>  <span class="hljs-attr">link</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpLink</span>(&#123;<br>    <span class="hljs-attr">uri</span>: <span class="hljs-string">&quot;http://localhost:4000&quot;</span>,<br>  &#125;),<br>&#125;);<br><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ApolloProvider</span> <span class="hljs-attr">client</span>=<span class="hljs-string">&#123;client&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">ApolloProvider</span>&gt;</span></span>,<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;root&quot;</span>)<br>);<br></code></pre></td></tr></table></figure>
<p>查询可以使用 <code>useQuery</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; gql, useQuery &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@apollo/client&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALL_PERSONS</span> = gql`<span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">query</span> <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    allPersons <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">      name</span><br><span class="language-graphql">      phone</span><br><span class="language-graphql">      id</span><br><span class="language-graphql">    <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">`</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">useQuery</span>(<span class="hljs-variable constant_">ALL_PERSONS</span>);<br><br>  <span class="hljs-keyword">if</span> (result.<span class="hljs-property">loading</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;result.data.allPersons.map((p) =&gt; p.name).join(&quot;, &quot;)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>如果是一个带参数的查询，可以：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FIND_PERSON</span> = gql`<span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">query</span> findPersonByName<span class="hljs-punctuation">(</span><span class="hljs-variable">$nameToSearch</span>: String<span class="hljs-punctuation">!</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    findPerson<span class="hljs-punctuation">(</span><span class="hljs-symbol">name</span><span class="hljs-punctuation">:</span> <span class="hljs-variable">$nameToSearch</span>) <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">      name</span><br><span class="language-graphql">      phone</span><br><span class="language-graphql">      id</span><br><span class="language-graphql">      address <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">        street</span><br><span class="language-graphql">        city</span><br><span class="language-graphql">      <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">    <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">`</span>;<br><br><span class="hljs-keyword">const</span> [nameToSearch, setNameToSearch] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> result = <span class="hljs-title function_">useQuery</span>(<span class="hljs-variable constant_">FIND_PERSON</span>, &#123;<br>  <span class="hljs-attr">variables</span>: &#123; nameToSearch &#125;,<br>  <span class="hljs-attr">skip</span>: !nameToSearch,<br>&#125;);<br><br><span class="hljs-keyword">if</span> (nameToSearch &amp;&amp; result.<span class="hljs-property">data</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Person</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">person</span>=<span class="hljs-string">&#123;result.data.findPerson&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onClose</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setNameToSearch(null)&#125;</span><br><span class="language-xml">    /&gt;</span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure>
<p>更新缓存有几种方法，第一种是 poll 服务器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> result = <span class="hljs-title function_">useQuery</span>(<span class="hljs-variable constant_">ALL_PERSONS</span>, &#123; <span class="hljs-attr">pollInterval</span>: <span class="hljs-number">2000</span> &#125;);<br></code></pre></td></tr></table></figure>
<p>缺点在于无意义的网络流量</p>
<p>第二种是使用 <code>refetchQueries</code>
定义，每当创建一个新的人，就重新进行获取所有人员的查询：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> [ createPerson ] = <span class="hljs-title function_">useMutation</span>(<span class="hljs-variable constant_">CREATE_PERSON</span>, &#123;<br>	<span class="hljs-attr">refetchQueries</span>: [ &#123; <span class="hljs-attr">query</span>: <span class="hljs-variable constant_">ALL_PERSONS</span> &#125;, &#123; <span class="hljs-attr">query</span>: <span class="hljs-variable constant_">OTHER_QUERY</span> &#125;, &#123; <span class="hljs-attr">query</span>: ... &#125; ]<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>缺点在于另一个用户更新的数据不会立刻反应给其他用户</p>
<p>可以定义错误处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">PersonForm</span> = (<span class="hljs-params">&#123; setError &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [createPerson] = <span class="hljs-title function_">useMutation</span>(<span class="hljs-variable constant_">CREATE_PERSON</span>, &#123;<br>    <span class="hljs-attr">refetchQueries</span>: [&#123; <span class="hljs-attr">query</span>: <span class="hljs-variable constant_">ALL_PERSONS</span> &#125;],<br>    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setError</span>(error.<span class="hljs-property">graphQLErrors</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>);<br>    &#125;,<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="数据库与用户管理">数据库与用户管理</h2>
<p>用户管理的模式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js">type <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">username</span>: <span class="hljs-title class_">String</span>!<br>  <span class="hljs-attr">friends</span>: [<span class="hljs-title class_">Person</span>!]!<br>  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>!<br>&#125;<br><br>type <span class="hljs-title class_">Token</span> &#123;<br>  <span class="hljs-attr">value</span>: <span class="hljs-title class_">String</span>!<br>&#125;<br><br>type <span class="hljs-title class_">Query</span> &#123;<br>  <span class="hljs-attr">me</span>: <span class="hljs-title class_">User</span><br>&#125;<br><br>type <span class="hljs-title class_">Mutation</span> &#123;<br>  <span class="hljs-title function_">createUser</span>(<br>    <span class="hljs-attr">username</span>: <span class="hljs-title class_">String</span>!<br>  ): <span class="hljs-title class_">User</span><br>  <span class="hljs-title function_">login</span>(<br>    <span class="hljs-attr">username</span>: <span class="hljs-title class_">String</span>!<br>    <span class="hljs-attr">password</span>: <span class="hljs-title class_">String</span>!<br>  ): <span class="hljs-title class_">Token</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>)<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">JWT_SECRET</span> = <span class="hljs-string">&#x27;NEED_HERE_A_SECRET_KEY&#x27;</span><br><br><span class="hljs-title class_">Mutation</span>: &#123;<br>  <span class="hljs-attr">createUser</span>: <span class="hljs-keyword">async</span> (root, args) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(&#123; <span class="hljs-attr">username</span>: args.<span class="hljs-property">username</span> &#125;)<br><br>    <span class="hljs-keyword">return</span> user.<span class="hljs-title function_">save</span>()<br>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInputError</span>(error.<span class="hljs-property">message</span>, &#123;<br>          <span class="hljs-attr">invalidArgs</span>: args,<br>        &#125;)<br>      &#125;)<br>  &#125;,<br>  <span class="hljs-attr">login</span>: <span class="hljs-keyword">async</span> (root, args) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>(&#123; <span class="hljs-attr">username</span>: args.<span class="hljs-property">username</span> &#125;)<br><br>    <span class="hljs-keyword">if</span> ( !user || args.<span class="hljs-property">password</span> !== <span class="hljs-string">&#x27;secret&#x27;</span> ) &#123; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInputError</span>(<span class="hljs-string">&quot;wrong credentials&quot;</span>) &#125;<br><br>    <span class="hljs-keyword">const</span> userForToken = &#123;<br>      <span class="hljs-attr">username</span>: user.<span class="hljs-property">username</span>,<br>      <span class="hljs-attr">id</span>: user.<span class="hljs-property">_id</span>,<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">value</span>: jwt.<span class="hljs-title function_">sign</span>(userForToken, <span class="hljs-variable constant_">JWT_SECRET</span>) &#125;<br>  &#125;,<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>在构造函数调用中添加第三个参数 <code>context</code> 来扩展
<code>server</code> 对象的定义。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApolloServer</span>(&#123;<br>  typeDefs,<br>  resolvers,<br><br>  <span class="hljs-attr">context</span>: <span class="hljs-keyword">async</span> (&#123; req &#125;) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> auth = req ? req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span> : <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (auth &amp;&amp; auth.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;bearer &quot;</span>)) &#123;<br>      <span class="hljs-keyword">const</span> decodedToken = jwt.<span class="hljs-title function_">verify</span>(auth.<span class="hljs-title function_">substring</span>(<span class="hljs-number">7</span>), <span class="hljs-variable constant_">JWT_SECRET</span>);<br>      <span class="hljs-keyword">const</span> currentUser = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findById</span>(decodedToken.<span class="hljs-property">id</span>).<span class="hljs-title function_">populate</span>(<br>        <span class="hljs-string">&quot;friends&quot;</span><br>      );<br>      <span class="hljs-keyword">return</span> &#123; currentUser &#125;;<br>    &#125;<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>
<h2 id="登录与更新缓存">登录与更新缓存</h2>
<p>向 header 中添加令牌：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; setContext &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@apollo/client/link/context&quot;</span>;<br><br><span class="hljs-keyword">const</span> authLink = <span class="hljs-title function_">setContext</span>(<span class="hljs-function">(<span class="hljs-params">_, &#123; headers &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;phonenumbers-user-token&quot;</span>);<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">headers</span>: &#123;<br>      ...headers,<br>      <span class="hljs-attr">authorization</span>: token ? <span class="hljs-string">`bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span> : <span class="hljs-literal">null</span>,<br>    &#125;,<br>  &#125;;<br>&#125;);<br><br><span class="hljs-keyword">const</span> httpLink = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpLink</span>(&#123; <span class="hljs-attr">uri</span>: <span class="hljs-string">&quot;http://localhost:4000&quot;</span> &#125;);<br><br><span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApolloClient</span>(&#123;<br>  <span class="hljs-attr">cache</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryCache</span>(),<br>  <span class="hljs-attr">link</span>: authLink.<span class="hljs-title function_">concat</span>(httpLink),<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>还有一种手动更新缓存的方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> [createPerson] = <span class="hljs-title function_">useMutation</span>(<span class="hljs-variable constant_">CREATE_PERSON</span>, &#123;<br>  <span class="hljs-attr">update</span>: <span class="hljs-function">(<span class="hljs-params">cache, response</span>) =&gt;</span> &#123;<br>    cache.<span class="hljs-title function_">updateQuery</span>(&#123; <span class="hljs-attr">query</span>: <span class="hljs-variable constant_">ALL_PERSONS</span> &#125;, <span class="hljs-function">(<span class="hljs-params">&#123; allPersons &#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">allPersons</span>: allPersons.<span class="hljs-title function_">concat</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">addPerson</span>),<br>      &#125;;<br>    &#125;);<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>
<h2 id="fragments-与-subscriptions">Fragments 与 subscriptions</h2>
<p>两个查询必须定义完全相同的字段时，可以通过 fragment 来简化，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PERSON_DETAILS</span> = gql`<span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">fragment</span> PersonDetails <span class="hljs-keyword">on</span> Person <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    id</span><br><span class="language-graphql">    name</span><br><span class="language-graphql">    phone</span><br><span class="language-graphql">    address <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">      street</span><br><span class="language-graphql">      city</span><br><span class="language-graphql">    <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">`</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FIND_PERSON</span> = gql`<span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">query</span> findPersonByName<span class="hljs-punctuation">(</span><span class="hljs-variable">$nameToSearch</span>: String<span class="hljs-punctuation">!</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    findPerson<span class="hljs-punctuation">(</span><span class="hljs-symbol">name</span><span class="hljs-punctuation">:</span> <span class="hljs-variable">$nameToSearch</span>) <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">      <span class="hljs-punctuation">...</span>PersonDetails</span><br><span class="language-graphql">    <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">  </span><span class="hljs-subst">$&#123;PERSON_DETAILS&#125;</span><span class="language-graphql"></span><br><span class="language-graphql">`</span>;<br></code></pre></td></tr></table></figure>
<p>Apollo 使用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">WebSockets</a>
进行服务器用户的通信</p>
<p>用 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.apollographql.com/docs/apollo-server/integrations/middleware/#apollo-server-express">Apollo
Server Express</a> 替换 Apollo 服务器</p>
<h1 id="typescript">TypeScript</h1>
<h2 id="背景与介绍">背景与介绍</h2>
<p>TypeScript 可以被编译为
JavaScript，是它的一个超集，由语言、编译器、语言服务三部分组成</p>
<p>一个例子：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> birthdayGreeter = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`Happy birthday <span class="hljs-subst">$&#123;name&#125;</span>, you are now <span class="hljs-subst">$&#123;age&#125;</span> years old!`</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>其中函数的返回值可以不写，能够自动推断出来</p>
<p>支持 callback：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">CallsFunction</span> = <span class="hljs-function">(<span class="hljs-params">callback: (result: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">func</span>: <span class="hljs-title class_">CallsFunction</span> = <span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">cb</span>(<span class="hljs-string">&#x27;done&#x27;</span>);<br>  <span class="hljs-title function_">cb</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-title function_">func</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123; <span class="hljs-keyword">return</span> result; &#125;);<br></code></pre></td></tr></table></figure>
<h2 id="typescript-的一小步">TypeScript 的一小步</h2>
<p>需要安装的包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm install --save-dev ts-node typescript<br></code></pre></td></tr></table></figure>
<p>可以自定义类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Operation</span> = <span class="hljs-string">&#x27;multiply&#x27;</span> | <span class="hljs-string">&#x27;add&#x27;</span> | <span class="hljs-string">&#x27;divide&#x27;</span>;<br></code></pre></td></tr></table></figure>
<p>也可以通过定义接口来定义类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MultiplyValues</span> &#123;<br>  <span class="hljs-attr">value1</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">value2</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>npm 包通常有对应的 typescript 版本，名称为
<code>@types/&#123;npm_package&#125;</code>，且总是应该安装在
<code>devDependencies</code> 中，并仍需要安装相应的 JavaScript 版本</p>
<p><code>tsconfig.json</code> 文件中包含了 TypeScript 的核心配置</p>
<h2 id="typescript-版的-express-应用">TypeScript 版的 express 应用</h2>
<p>使用 <code>tsc</code>生成 <code>tsconfig.json</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm run tsc -- --init<br></code></pre></td></tr></table></figure>
<p><code>nodemon</code> 的 TypeScript 替代品为
<code>ts-node-dev</code></p>
<p>关键字 <code>as</code> 断言变量类型</p>
<p>可以通过在类型声明中添加 <code>?</code>，将字段的类型设置为
optional</p>
<p>注意节点模块的加载顺序：<code>["js", "json", "node", "ts", "tsx"]</code>，最好的方法是避免重名</p>
<p><code>Pick</code> 实用类型允许选择想使用的现有类型的哪些字段：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> getNonSensitiveEntries = (): <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">DiaryEntry</span>, <span class="hljs-string">&#x27;id&#x27;</span> | <span class="hljs-string">&#x27;date&#x27;</span> | <span class="hljs-string">&#x27;weather&#x27;</span> | <span class="hljs-string">&#x27;visibility&#x27;</span>&gt;[] =&gt; &#123; &#125;<br></code></pre></td></tr></table></figure>
<p><code>Omit</code> 可以用来声明要排除哪些字段：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">NonSensitiveDiaryEntry</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">DiaryEntry</span>, <span class="hljs-string">&#x27;comment&#x27;</span>&gt;;<br></code></pre></td></tr></table></figure>
<p>注意这只是禁止访问而已，并不是不返回那些被排除的字段而已，所以需要手动排除这些字段：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> getNonSensitiveEntries = (): <span class="hljs-title class_">NonSensitiveDiaryEntry</span>[] =&gt; &#123;<br>  <span class="hljs-keyword">return</span> diaries.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">&#123; id, date &#125;</span>) =&gt;</span> (&#123; id, date, &#125;));<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>使用 <code>unknown</code> 可以先验证类型，然后确认预期类型，如：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> parseComment = (<span class="hljs-attr">comment</span>: <span class="hljs-built_in">unknown</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (!comment || !<span class="hljs-title function_">isString</span>(comment)) &#123; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Incorrect or missing comment&#x27;</span>); &#125;<br>  <span class="hljs-keyword">return</span> comment;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="利用-typescript-编写-react-应用">利用 TypeScript 编写 React
应用</h2>
<p>创建一个 TypeScript 应用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">npx create-react-app my-app --template typescript<br></code></pre></td></tr></table></figure>
<p>组件：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Welcome</span> = (<span class="hljs-params">&#123; name &#125;: &#123; name: <span class="hljs-built_in">string</span> &#125;</span>) =&gt; (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, &#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure>
<p>接口可以继承，这样就可以不同类型共享相同的域，然后通过
<code>switch</code> 等语句区分不同的具体类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoursePartBase</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">exerciseCount</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoursePartOne</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CoursePartBase</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Fundamentals&quot;</span>;<br>  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoursePartTwo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CoursePartBase</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Using props to pass data&quot;</span>;<br>  <span class="hljs-attr">groupProjectCount</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">CoursePart</span> = <span class="hljs-title class_">CoursePartOne</span> | <span class="hljs-title class_">CoursePartTwo</span>;<br></code></pre></td></tr></table></figure>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%B5%AB%E5%B0%94%E8%BE%9B%E5%9F%BA%E5%A4%A7%E5%AD%A6/">赫尔辛基大学</a><a class="post-meta__tags" href="/tags/web/">web</a></div><div class="post_share"><div class="social-share" data-image="/gallery/cover/%E5%85%A8%E6%A0%88%E5%85%AC%E5%BC%80%E8%AF%BE.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/13aafbc3.html" title="包管理器"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/gallery/cover/%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">包管理器</div></div></a></div><div class="next-post pull-right"><a href="/posts/cc1b9611.html" title="JavaScript"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/gallery/cover/JavaScript.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">JavaScript</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="iconfont icon-tuijian"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/cc1b9611.html" title="JavaScript"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/gallery/cover/JavaScript.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-25</div><div class="title">JavaScript</div></div></a></div><div><a href="/posts/5dc45f0c.html" title="Jupyter Notebook 学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/gallery/cover/Jupyter%20Notebook%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-16</div><div class="title">Jupyter Notebook 学习笔记</div></div></a></div><div><a href="/posts/13aafbc3.html" title="包管理器"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/gallery/cover/%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-31</div><div class="title">包管理器</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/illustration/%E5%A4%B4%E5%83%8F_%E7%81%B0%E5%A4%AA%E7%8B%BC.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">old_driver_zero</div><div class="author-info__description">我一定会回来的</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">103</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">161</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-RSS_flat"/></svg></a><a class="social-icon faa-parent animated-hover" href="https://github.com/old-driver-zero" target="_blank" title="GitHub" rel="external nofollow noopener noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-github"/></svg></a><a class="social-icon faa-parent animated-hover" href="mailto:2771503468@qq.com" target="_blank" title="QQ邮箱" rel="external nofollow noopener noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"/></svg></a><a class="social-icon faa-parent animated-hover" href="https://steamcommunity.com/id/old_driver_zero" target="_blank" title="Steam" rel="external nofollow noopener noreferrer"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-steam"/></svg></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><a class="faa-parent animated-hover"><svg class="faa-tada icon" style="height:25px;width:25px;fill:currentColor;position:relative;top:5px" aria-hidden="true"><use xlink:href="#icon-mulu"/></svg></a><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#web-app-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">Web app 基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#react-%E5%85%A5%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">React 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#react-%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">React 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E7%8A%B6%E6%80%81%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">组件状态，事件处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5-react-%E5%BA%94%E7%94%A8%E8%B0%83%E8%AF%95"><span class="toc-number">2.3.</span> <span class="toc-text">深入 React 应用调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%80%9A%E4%BF%A1"><span class="toc-number">3.</span> <span class="toc-text">与服务端通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E6%B8%B2%E6%9F%93%E9%9B%86%E5%90%88%E5%88%B0%E6%A8%A1%E5%9D%97%E5%AD%A6%E4%B9%A0"><span class="toc-number">3.1.</span> <span class="toc-text">从渲染集合到模块学习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95"><span class="toc-number">3.2.</span> <span class="toc-text">表单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">3.3.</span> <span class="toc-text">从服务器获取数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B0%86%E6%95%B0%E6%8D%AE-alert-%E5%87%BA%E6%9D%A5"><span class="toc-number">3.4.</span> <span class="toc-text">在服务端将数据 Alert 出来</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%99-react-%E5%BA%94%E7%94%A8%E5%8A%A0%E7%82%B9%E6%A0%B7%E5%BC%8F"><span class="toc-number">3.5.</span> <span class="toc-text">给 React 应用加点样式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8-nodejs-%E5%92%8C-express-%E5%86%99%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.</span> <span class="toc-text">用 NodeJS 和 Express
写服务端程序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#node.js-%E4%B8%8E-express"><span class="toc-number">4.1.</span> <span class="toc-text">Node.js 与 Express</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E5%88%B0%E7%BD%91%E4%B8%8A"><span class="toc-number">4.2.</span> <span class="toc-text">把应用部署到网上</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E6%95%B0%E6%8D%AE%E5%AD%98%E5%85%A5-mongodb"><span class="toc-number">4.3.</span> <span class="toc-text">将数据存入 MongoDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eslint-%E4%B8%8E%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5"><span class="toc-number">4.4.</span> <span class="toc-text">ESLint 与代码检查</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-express-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A8%8B%E5%BA%8F-%E4%BB%A5%E5%8F%8A%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">测试 Express 服务端程序,
以及用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E5%90%8E%E7%AB%AF%E7%BB%93%E6%9E%84%E5%88%B0%E6%B5%8B%E8%AF%95%E5%85%A5%E9%97%A8"><span class="toc-number">5.1.</span> <span class="toc-text">从后端结构到测试入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%90%8E%E7%AB%AF%E5%BA%94%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">测试后端应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">5.3.</span> <span class="toc-text">用户管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E8%AE%A4%E8%AF%81"><span class="toc-number">5.4.</span> <span class="toc-text">密钥认证</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-react-%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">测试 React 应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%88%90%E5%89%8D%E5%8F%B0%E7%9A%84%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">6.1.</span> <span class="toc-text">完成前台的登录功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#props.children-%E4%B8%8E-proptypes"><span class="toc-number">6.2.</span> <span class="toc-text">props.children 与 proptypes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-react-%E5%BA%94%E7%94%A8-1"><span class="toc-number">6.3.</span> <span class="toc-text">测试 React 应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95"><span class="toc-number">6.4.</span> <span class="toc-text">端到端测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-redux-%E8%BF%9B%E8%A1%8C%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">利用 Redux 进行状态管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flux-%E6%9E%B6%E6%9E%84%E4%B8%8E-redux"><span class="toc-number">7.1.</span> <span class="toc-text">Flux 架构与 Redux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%82%B9-reducers"><span class="toc-number">7.2.</span> <span class="toc-text">再来点 reducers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8-redux-%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B8%8E%E5%90%8E%E7%AB%AF%E9%80%9A%E4%BF%A1"><span class="toc-number">7.3.</span> <span class="toc-text">在 Redux 应用中与后端通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-queryusereducer-%E5%92%8C-context"><span class="toc-number">7.4.</span> <span class="toc-text">React Query，useReducer 和
context</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#react-router%E8%87%AA%E5%AE%9A%E4%B9%89-hook%E5%88%A9%E7%94%A8-css-%E5%92%8C-webpack-%E7%BB%99-app-%E6%B7%BB%E5%8A%A0%E6%A0%B7%E5%BC%8F"><span class="toc-number">8.</span> <span class="toc-text">React
router、自定义 hook，利用 CSS 和 webpack 给 app 添加样式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#react-router"><span class="toc-number">8.1.</span> <span class="toc-text">React-router</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-hooks"><span class="toc-number">8.2.</span> <span class="toc-text">自定义 hooks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B7%E5%BC%8F%E8%BF%9B%E9%98%B6"><span class="toc-number">8.3.</span> <span class="toc-text">样式进阶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#webpack"><span class="toc-number">8.4.</span> <span class="toc-text">Webpack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E5%90%84%E6%A0%B7%E7%9A%84-class-components"><span class="toc-number">8.5.</span> <span class="toc-text">各种各样的 Class components</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#graphql"><span class="toc-number">9.</span> <span class="toc-text">GraphQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#graphql-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">9.1.</span> <span class="toc-text">GraphQL 服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-%E4%B8%8E-graphql"><span class="toc-number">9.2.</span> <span class="toc-text">React 与 GraphQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-number">9.3.</span> <span class="toc-text">数据库与用户管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E4%B8%8E%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98"><span class="toc-number">9.4.</span> <span class="toc-text">登录与更新缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fragments-%E4%B8%8E-subscriptions"><span class="toc-number">9.5.</span> <span class="toc-text">Fragments 与 subscriptions</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#typescript"><span class="toc-number">10.</span> <span class="toc-text">TypeScript</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%B8%8E%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.1.</span> <span class="toc-text">背景与介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typescript-%E7%9A%84%E4%B8%80%E5%B0%8F%E6%AD%A5"><span class="toc-number">10.2.</span> <span class="toc-text">TypeScript 的一小步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#typescript-%E7%89%88%E7%9A%84-express-%E5%BA%94%E7%94%A8"><span class="toc-number">10.3.</span> <span class="toc-text">TypeScript 版的 express 应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-typescript-%E7%BC%96%E5%86%99-react-%E5%BA%94%E7%94%A8"><span class="toc-number">10.4.</span> <span class="toc-text">利用 TypeScript 编写 React
应用</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>不必要做的事不做，必须做的一律从简</div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/comments/">留点什么</a><a href="/random/">随便逛逛</a></li><li><a href="/about/">关于</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/gallery/">我的画廊</a><a href="/charts/">网站统计</a></li></ul></div></div></div></div><div class="copyright">&copy;2022 - 2024 By old_driver_zero</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://my-twikoo-puce.vercel.app/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://my-twikoo-puce.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async src="//at.alicdn.com/t/c/font_4031045_izvon5l4fr8.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></html>